{% extends "base.html" %}
{% block content %}
<section class="hero">
  <div>
    <h1>Settings</h1>
    <p class="lead">Rename fan channels before applying profiles. Defaults mirror the OCTO labels.</p>
  </div>
</section>

<section class="panel">
  <div class="panel__header">
    <h2>Fan Channels</h2>
    <span class="panel__tag">Rename</span>
  </div>
  <form class="settings-count" method="post" action="/settings/fan-count">
    <label class="form__label">Active fan count</label>
    <div class="settings-count__row">
      <input class="form__input" type="number" name="fan_count" min="1" max="16" value="{{ fan_count }}" required />
      <button class="button button--ghost" type="submit">Update Count</button>
    </div>
  </form>
  <form class="settings-calibrate" method="post" action="/settings/fans/calibrate" id="calibrate-form">
    <div class="settings-calibrate__body">
      <div class="settings-calibrate__title">Calibrate fan max RPM</div>
      <div class="settings-calibrate__note">Sets all fans to 100%, waits 15 seconds, reads RPM, then restores the active profile or 20%.</div>
    </div>
    <button class="button" type="submit">Calibrate</button>
  </form>
  <form class="settings-calibrate" method="post" action="/settings/pump">
    <div class="settings-calibrate__body">
      <div class="settings-calibrate__title">Pump channel mapping</div>
      <div class="settings-calibrate__note">Select the fan channel that represents the pump PWM output.</div>
    </div>
    <div class="settings-pump">
      <label class="settings-pump__option">
        <input type="radio" name="pump_channel" value="none" {% if pump_channel is none %}checked{% endif %} />
        <span>No pump mapped</span>
      </label>
      {% for fan in fans %}
      <label class="settings-pump__option">
        <input type="radio" name="pump_channel" value="{{ fan.channel_index }}" {% if pump_channel == fan.channel_index %}checked{% endif %} />
        <span>Channel {{ fan.channel_index }} · {{ fan.name }}</span>
      </label>
      {% endfor %}
    </div>
    <button class="button button--ghost" type="submit">Set Pump</button>
  </form>
  <div class="modal" id="calibrate-modal" aria-hidden="true">
    <div class="modal__backdrop"></div>
    <div class="modal__card">
      <div class="modal__title">Wait for calibration to finish</div>
      <div class="modal__timer">00:15</div>
      <div class="modal__note">Calibration is running. This window will close when the timer ends.</div>
    </div>
  </div>
  <div class="settings-list">
    {% for fan in fans %}
    <form class="settings-row" method="post" action="/settings/fans">
      <input type="hidden" name="fan_id" value="{{ fan.id }}" />
      <div class="settings-row__label">Channel {{ fan.channel_index }}</div>
      <div class="settings-row__meta">
        Default: {{ fan.default_name }}
        {% if fan.active == 0 %}
        <span class="settings-row__inactive">Inactive</span>
        {% endif %}
      </div>
      <input class="form__input" type="text" name="name" value="{{ fan.name }}" required />
      <input class="form__input" type="number" name="max_rpm" value="{{ fan.max_rpm or '' }}" min="0" placeholder="Max RPM" {% if pump_channel == fan.channel_index %}disabled{% endif %} />
      <button class="button button--ghost" type="submit">Update</button>
    </form>
    {% endfor %}
  </div>
</section>

<section class="panel">
  <div class="panel__header">
    <h2>Sensors</h2>
    <span class="panel__tag">Rename</span>
  </div>
  <div class="settings-list">
    {% for sensor in sensors %}
    <form class="settings-row" method="post" action="/settings/sensors">
      <input type="hidden" name="sensor_id" value="{{ sensor.id }}" />
      <div class="settings-row__label">{{ sensor.name }}</div>
      <div class="settings-row__meta">
        Default: {{ sensor.default_name }} · {{ sensor.kind }} {{ sensor.source_id }}
      </div>
      <input class="form__input" type="text" name="name" value="{{ sensor.name }}" required />
      <select class="form__input" name="unit">
        <option value="C" {% if sensor.unit == 'C' %}selected{% endif %}>°C</option>
        <option value="F" {% if sensor.unit == 'F' %}selected{% endif %}>°F</option>
      </select>
      <button class="button button--ghost" type="submit">Update</button>
    </form>
    {% endfor %}
  </div>
</section>
<script src="/static/js/settings.js"></script>
{% endblock %}
