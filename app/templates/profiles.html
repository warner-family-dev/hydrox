{% extends "base.html" %}
{% block content %}
<section class="hero">
  <div>
    <h1>Profile Creator</h1>
    <p class="lead">Map sensors to fan channels and shape how PWM scales with temperature. Profiles apply continuously when active.</p>
  </div>
</section>

<section class="split">
  <div class="panel">
    <div class="panel__header">
      <h2>Create Profile</h2>
      <span class="panel__tag">Draft</span>
    </div>
    {% if error %}
    <div class="alert">{{ error }}</div>
    {% endif %}
    <form class="form" method="post" action="/profiles" id="profile-form" data-profile-form>
      <input type="hidden" name="profile_id" value="" data-profile-id />
      <label class="form__label">Profile Name</label>
      <input class="form__input" type="text" name="name" placeholder="Cellar Quiet Curve" required data-profile-name />

      <div class="profile-builder">
        <div class="profile-builder__controls">
          <label class="form__label">Sensor</label>
          <select class="form__input" data-profile-sensor>
            <option value="cpu">CPU Temp</option>
            {% for sensor in sensors %}
            <option value="{{ sensor.id }}">{{ sensor.name }}</option>
            {% endfor %}
          </select>

          <label class="form__label">Fan Channels</label>
          <div class="profile-builder__fans">
            {% for fan in fans %}
            <label class="profile-builder__fan">
              <input type="checkbox" value="{{ fan.channel_index }}" />
              <span>Channel {{ fan.channel_index }} · {{ fan.name }}</span>
            </label>
            {% endfor %}
          </div>

          <button class="button button--ghost" type="button" data-profile-add>Add Curve</button>
        </div>
      </div>

      <div class="profile-rules">
        <div class="profile-rules__title">Mapped Curves</div>
        <div class="profile-rules__list" data-profile-rules></div>
      </div>

      <details class="profile-settings" open>
        <summary class="profile-settings__summary">Optional Settings</summary>
        <div class="profile-settings__section">
          <div class="profile-settings__title">Control Smoothing (seconds)</div>
          <div class="profile-settings__grid">
            <label class="profile-settings__field">
              <span class="form__label">Sensor smoothing</span>
              <input class="form__input" type="number" min="0" name="sensor_smoothing_sec" value="0" data-profile-setting />
            </label>
            <label class="profile-settings__field">
              <span class="form__label">Fan smoothing</span>
              <input class="form__input" type="number" min="0" name="fan_smoothing_sec" value="0" data-profile-setting />
            </label>
            <label class="profile-settings__field">
              <span class="form__label">Pump smoothing</span>
              <input class="form__input" type="number" min="0" name="pump_smoothing_sec" value="0" data-profile-setting />
            </label>
          </div>
        </div>
        <div class="profile-settings__section">
          <div class="profile-settings__title">Rate Limits (RPM per update)</div>
          <div class="profile-settings__grid">
            <label class="profile-settings__field">
              <span class="form__label">Fan rate limit</span>
              <input class="form__input" type="number" min="0" name="fan_rate_limit_rpm" value="0" data-profile-setting />
            </label>
            <label class="profile-settings__field">
              <span class="form__label">Pump rate limit</span>
              <input class="form__input" type="number" min="0" name="pump_rate_limit_rpm" value="0" data-profile-setting />
            </label>
          </div>
        </div>
        <div class="profile-settings__section">
          <div class="profile-settings__title">Safety Limits (non-CPU sensors)</div>
          <div class="profile-settings__grid">
            <label class="profile-settings__field">
              <span class="form__label">Sensor min °C</span>
              <input class="form__input" type="number" name="sensor_min_c" placeholder="optional" data-profile-setting />
            </label>
            <label class="profile-settings__field">
              <span class="form__label">Sensor max °C</span>
              <input class="form__input" type="number" name="sensor_max_c" placeholder="optional" data-profile-setting />
            </label>
          </div>
        </div>
        <div class="profile-settings__section">
          <div class="profile-settings__title">Fallback Sensor Mapping (optional)</div>
          <div class="profile-settings__fallbacks">
            {% for sensor in sensors %}
            <label class="profile-settings__fallback">
              <span>{{ sensor.name }}</span>
              <select class="form__input" data-fallback-source="{{ sensor.id }}">
                <option value="">None</option>
                <option value="cpu">CPU Temp</option>
                {% for backup in sensors %}
                {% if backup.id != sensor.id %}
                <option value="{{ backup.id }}">{{ backup.name }}</option>
                {% endif %}
                {% endfor %}
              </select>
            </label>
            {% endfor %}
          </div>
        </div>
      </details>

      <textarea class="form__textarea profile-json" name="curve_json" rows="8" data-profile-json readonly required></textarea>
      <input type="hidden" name="schedule_json" value="" />

      <button class="button" type="submit" data-profile-submit>Save Profile</button>
    </form>
  </div>
  <div class="panel">
    <div class="panel__header">
      <h2>Saved Profiles</h2>
      <span class="panel__tag">SQLite</span>
    </div>
    <div class="panel__note">Auto-cycle interval: {{ profile_loop_seconds }}s (active profile sensor smoothing)</div>
    <div class="list">
      {% if profiles %}
        {% for profile in profiles %}
        <div class="list__item">
          <div class="list__title">
            {{ profile.name }}
            {% if active_profile_id == profile.id %}
            <span class="list__badge">Active</span>
            {% endif %}
          </div>
          <div class="list__meta">{{ profile.created_at }}</div>
          <div class="list__body">Curve: {{ profile.curve_json }}</div>
          {% if profile.schedule_json %}
          <div class="list__body">Schedule: {{ profile.schedule_json }}</div>
          {% endif %}
          <form method="post" action="/profiles/apply">
            <input type="hidden" name="profile_id" value="{{ profile.id }}" />
            <button class="button button--ghost" type="submit">Apply Profile</button>
          </form>
          <button
            class="button button--ghost"
            type="button"
            data-profile-edit
            data-profile-id="{{ profile.id }}"
            data-profile-name="{{ profile.name }}"
            data-profile-curve='{{ profile.curve_json | tojson }}'
          >
            Edit
          </button>
          <form method="post" action="/profiles/default">
            <input type="hidden" name="profile_id" value="{{ profile.id }}" />
            <label class="profile-default">
              <input type="radio" name="default_profile" value="{{ profile.id }}" {% if default_profile_id == profile.id %}checked{% endif %} />
              <span>Default on boot</span>
            </label>
            <button class="button button--ghost" type="submit">Set Default</button>
          </form>
        </div>
        {% endfor %}
      {% else %}
        <div class="empty">No profiles yet. Create the first curve to get started.</div>
      {% endif %}
    </div>
  </div>
</section>
<div class="profile-modal" data-profile-modal>
  <div class="profile-modal__overlay" data-profile-close></div>
  <div class="profile-modal__panel">
    <div class="profile-modal__header">
      <div>
        <div class="profile-modal__title">Curve Editor</div>
        <div class="profile-modal__sub">Click to add points · Right-click to remove</div>
      </div>
      <button class="profile-modal__close" type="button" data-profile-close>×</button>
    </div>
    <div class="profile-chart profile-chart--modal" data-profile-chart>
      <svg viewBox="0 0 900 520" class="profile-chart__svg" aria-hidden="true">
        <g class="profile-chart__grid" data-profile-grid></g>
        <g class="profile-chart__axes">
          <line x1="60" y1="30" x2="60" y2="470" />
          <line x1="60" y1="470" x2="860" y2="470" />
        </g>
        <g class="profile-chart__labels">
          <text x="30" y="38" text-anchor="end">100%</text>
          <text x="60" y="492" text-anchor="middle">0</text>
          <text x="140" y="492" text-anchor="middle">10</text>
          <text x="220" y="492" text-anchor="middle">20</text>
          <text x="300" y="492" text-anchor="middle">30</text>
          <text x="380" y="492" text-anchor="middle">40</text>
          <text x="460" y="492" text-anchor="middle">50</text>
          <text x="540" y="492" text-anchor="middle">60</text>
          <text x="620" y="492" text-anchor="middle">70</text>
          <text x="700" y="492" text-anchor="middle">80</text>
          <text x="780" y="492" text-anchor="middle">90</text>
          <text x="860" y="492" text-anchor="middle">100</text>
          <text x="30" y="470" text-anchor="end">0%</text>
          <text x="30" y="426" text-anchor="end">10%</text>
          <text x="30" y="382" text-anchor="end">20%</text>
          <text x="30" y="338" text-anchor="end">30%</text>
          <text x="30" y="294" text-anchor="end">40%</text>
          <text x="30" y="250" text-anchor="end">50%</text>
          <text x="30" y="206" text-anchor="end">60%</text>
          <text x="30" y="162" text-anchor="end">70%</text>
          <text x="30" y="118" text-anchor="end">80%</text>
          <text x="30" y="74" text-anchor="end">90%</text>
          <text x="460" y="508" text-anchor="middle">Temperature (°C)</text>
          <text x="8" y="260" text-anchor="middle" transform="rotate(-90 8 260)">Fan Output (%)</text>
        </g>
        <polyline class="profile-chart__line" data-profile-line fill="none" stroke="var(--accent)" stroke-width="2" />
        <g class="profile-chart__points" data-profile-points></g>
      </svg>
    </div>
    <div class="profile-modal__actions">
      <button class="button button--ghost" type="button" data-profile-cancel>Cancel</button>
      <button class="button" type="button" data-profile-save>Save Curve</button>
    </div>
  </div>
</div>
<script>
  window.PROFILE_DATA = {
    fans: {{ fans | tojson }},
    sensors: {{ sensors | tojson }},
  };
</script>
<script src="/static/js/profiles.js"></script>
{% endblock %}
