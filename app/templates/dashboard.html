{% extends "base.html" %}
{% block content %}
<section class="hero">
  <div>
    <h1>Cellar telemetry at a glance.</h1>
    <p class="lead">Live readouts for thermals, pump output, and fan RPMs. Profiles and screens are staged until you deploy them.</p>
  </div>
  <div class="status-card">
    <div class="status-card__label">System Pulse</div>
    <div class="status-card__value">Liquidctl</div>
    <div class="status-card__sub">{{ liquidctl_status }}</div>
  </div>
</section>

<section class="grid">
  <div class="metric-card">
    <div class="metric-card__label">CPU Temp</div>
    <div class="metric-card__value" data-metric="cpu_temp">{{ metrics.cpu_temp if metrics else "--" }}°C</div>
    <div class="metric-card__sub">Pi core</div>
  </div>
  <div class="metric-card">
    <div class="metric-card__label">970 Pro SSD Temp</div>
    <div class="metric-card__value" data-metric="ambient_temp">{{ metrics.ambient_temp if metrics else "--" }}°C</div>
    <div class="metric-card__sub">NVMe drive</div>
  </div>
  <div class="metric-card">
    <div class="metric-card__label">CPU Fan %</div>
    <div class="metric-card__value" data-metric="cpu_fan_percent">
      {% if cpu_fan_percent is not none %}{{ cpu_fan_percent }}%{% else %}--{% endif %}
    </div>
    <div class="metric-card__sub">Percent of 8000 RPM</div>
  </div>
  <div class="metric-card">
    <div class="metric-card__label">Pump %</div>
    <div class="metric-card__value" data-metric="pump_percent">
      {% if metrics and metrics.pump_percent is not none %}{{ metrics.pump_percent }}%{% else %}--{% endif %}
    </div>
    <div class="metric-card__sub">Remote PWM board</div>
  </div>
</section>

<section class="split">
  <div class="panel">
    <div class="panel__header">
      <h2>Sensors</h2>
      <span class="panel__tag">Live</span>
    </div>
    <div class="fan-grid">
      {% for sensor in sensors %}
      <div class="fan-tile" data-sensor-id="{{ sensor.id }}">
        <div class="fan-tile__title">{{ sensor.name }}</div>
        <div class="fan-tile__value">{{ sensor.display }}</div>
        <div class="fan-tile__sub">{{ sensor.kind }} {{ sensor.source_id }}</div>
      </div>
      {% endfor %}
    </div>
  </div>
  <div class="panel">
    <div class="panel__header">
      <h2>Temperature Trend</h2>
      <span class="panel__tag">Last 12 samples</span>
    </div>
    <div class="sparkline__toggles">
      <label class="toggle">
        <input type="checkbox" data-target="cpu-line" checked />
        <span>CPU</span>
      </label>
      <label class="toggle">
        <input type="checkbox" data-target="ambient-line" checked />
        <span>970 Pro SSD</span>
      </label>
      {% for sensor in sensors %}
      <label class="toggle" data-series="sensor_{{ sensor.id }}">
        <input type="checkbox" data-target="sensor-{{ sensor.id }}-line" checked />
        <span>{{ sensor.name }}</span>
      </label>
      {% endfor %}
    </div>
    <div class="trend">
      <div class="trend__axis trend__axis--y">Temperature (°C)</div>
      <div class="trend__axis trend__axis--x">Samples (oldest → newest)</div>
      <svg viewBox="0 0 520 240" class="trend__chart" data-chart="temperature" aria-hidden="true">
        <g class="trend__grid" id="trend-grid"></g>
        <g class="trend__labels" id="trend-labels"></g>
        <g class="trend__axes">
          <line x1="40" y1="20" x2="40" y2="210" />
          <line x1="40" y1="210" x2="500" y2="210" />
        </g>
        <g class="trend__lines">
          <polyline id="cpu-line" data-temp-line="cpu" fill="none" stroke="var(--accent)" stroke-width="2" />
          <polyline id="ambient-line" data-temp-line="ambient" fill="none" stroke="var(--alert)" stroke-width="2" />
          {% for sensor in sensors %}
          <polyline id="sensor-{{ sensor.id }}-line" data-temp-line="sensor_{{ sensor.id }}" fill="none" stroke="var(--accent)" stroke-width="2" />
          {% endfor %}
        </g>
      </svg>
      <div class="trend__tooltip" data-tooltip="temperature"></div>
    </div>
    <div class="sparkline__note">Historical samples are seeded until ingestion is wired in.</div>
  </div>
</section>

<section class="split">
  <div class="panel">
    <div class="panel__header">
      <h2>Fan Channels</h2>
      <span class="panel__tag">Configurable</span>
    </div>
    <div class="fan-grid">
      {% for fan in fans %}
      <div class="fan-tile" data-fan-channel="{{ fan.channel_index }}" data-fan-name="{{ fan.name }}" data-fan-max-rpm="{{ fan.max_rpm if fan.max_rpm else '' }}" data-is-pump="{{ 'true' if pump_channel == fan.channel_index else 'false' }}">
        <div class="fan-tile__title">{{ fan.name }}</div>
        <div class="fan-tile__value">-- RPM</div>
        <div class="fan-tile__sub">Awaiting live feed</div>
      </div>
      {% endfor %}
    </div>
  </div>
  <div class="panel">
    <div class="panel__header">
      <h2>Fan Output</h2>
      <span class="panel__tag">Percent of max RPM</span>
    </div>
    <div class="sparkline__toggles">
      {% for fan in fans %}
      <label class="toggle {% if not fan.max_rpm %}toggle--disabled{% endif %}" data-series="fan_{{ fan.channel_index }}" {% if not fan.max_rpm %}title="Unable to determine fan max RPM - Please calibrate in settings"{% endif %}>
        <input type="checkbox" data-target="fan-{{ fan.channel_index }}-line" {% if not fan.max_rpm %}disabled{% endif %} {% if fan.max_rpm %}checked{% endif %} />
        <span>{{ fan.name }}</span>
      </label>
      {% endfor %}
      <label class="toggle" data-series="cpu_fan" title="CPU fan max RPM is fixed at 8000">
        <input type="checkbox" data-target="cpu-fan-line" checked />
        <span>CPU Fan</span>
      </label>
      <label class="toggle" data-series="pump">
        <input type="checkbox" data-target="pump-line" checked />
        <span>Pump</span>
      </label>
    </div>
    <div class="trend">
      <div class="trend__axis trend__axis--y">Output (%)</div>
      <div class="trend__axis trend__axis--x">Samples (oldest → newest)</div>
      <svg viewBox="0 0 520 240" class="trend__chart" data-chart="fan" aria-hidden="true">
        <g class="trend__grid" id="fan-grid"></g>
        <g class="trend__labels" id="fan-labels"></g>
        <g class="trend__axes">
          <line x1="40" y1="20" x2="40" y2="210" />
          <line x1="40" y1="210" x2="500" y2="210" />
        </g>
        <g class="trend__lines">
          {% for fan in fans %}
          <polyline id="fan-{{ fan.channel_index }}-line" fill="none" stroke="var(--accent)" stroke-width="2" />
          {% endfor %}
          <polyline id="cpu-fan-line" fill="none" stroke="#22c55e" stroke-width="2" />
          <polyline id="pump-line" fill="none" stroke="#f97316" stroke-width="2" />
        </g>
      </svg>
      <div class="trend__tooltip" data-tooltip="fan"></div>
    </div>
    <div class="sparkline__note">Fan lines require max RPM values from calibration or manual entry.</div>
  </div>
</section>
<section class="modal" id="fan-modal" aria-hidden="true">
  <div class="modal__overlay" data-modal-close></div>
  <div class="modal__panel" role="dialog" aria-modal="true" aria-labelledby="fan-modal-title">
    <div class="modal__header">
      <div>
        <h3 id="fan-modal-title">Manual Fan Control</h3>
        <div class="modal__sub" data-modal-fan>Fan</div>
      </div>
      <button class="modal__close" type="button" data-modal-close aria-label="Close">×</button>
    </div>
    <div class="mode-toggle" role="tablist">
      <button class="mode-toggle__button mode-toggle__button--active" type="button" data-mode="percent">Percent</button>
      <button class="mode-toggle__button" type="button" data-mode="rpm">RPM</button>
    </div>
    <div class="modal__body">
      <label class="form__label" for="fan-percent-input">PWM Percent</label>
      <input class="form__input" id="fan-percent-input" type="number" min="0" max="100" step="1" value="50" data-input-percent />

      <label class="form__label" for="fan-rpm-input">Target RPM</label>
      <input class="form__input" id="fan-rpm-input" type="number" min="0" step="1" value="0" data-input-rpm />

      <div class="modal__row modal__row--hidden" data-pump-auth>
        <label class="form__label" for="fan-admin-password">Admin password</label>
        <input class="form__input" id="fan-admin-password" type="password" placeholder="admin" data-admin-password />
      </div>

      <div class="modal__note" data-modal-note></div>
      <div class="modal__error" data-modal-error></div>
    </div>
    <div class="modal__footer">
      <button class="button button--ghost" type="button" data-modal-cancel>Cancel</button>
      <button class="button" type="button" data-modal-save>Save</button>
    </div>
  </div>
</section>
<script src="/static/js/dashboard.js"></script>
{% endblock %}
